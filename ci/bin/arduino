#!/bin/bash

if [ "$(type -t preferences)" != "function" ]
then
    . "$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)"/preferences
fi

if [ "$(type -t sketchbook)" != "function" ]
then
    . "$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)"/sketchbook
fi

if [ "$(type -t arduino_exe)" != "function" ]
then
    . "$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)"/arduino_exe
fi

if [ "$(type -t cache_ide)" != "function" ]
then
    . "$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)"/cache_ide
fi

arduino() {
    OS="$(os "$@")"
    DIR="$(dir "$@")"
    VERSION="$(version "$@")"
    PREFERENCES="$(preferences "$@")"
    SKETCHBOOK="$(sketchbook "$@")"    
    ARDUINO_EXE="$(arduino_exe "$@")"

    if [ ! -r "$ARDUINO_EXE" ]
    then
	echo "Arduido executable $ARDUINO_EXE missing (caching)..."
	if ! cache_ide "$@"
	then
	    exit 1
	fi
    fi
    "$ARDUINO_EXE" --preferences-file "$PREFERENCES" --pref sketchbook.path="$SKETCHBOOK" --pref update.check=false "$@"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
    arduino "$@"
fi
